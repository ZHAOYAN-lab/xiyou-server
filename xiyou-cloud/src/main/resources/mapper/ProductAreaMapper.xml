<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ifengniao.server.xiyoucloud.mapper.ProductAreaMapper">

    <!-- 新增区域 -->
    <insert id="add" parameterType="com.ifengniao.server.xiyoucloud.entity.ProductAreaEntity">
        INSERT INTO xy_product_area (
            object_name,
            belong_type,
            icon_url,
            map_ids,
            area_content,
            create_time,
            update_time
        )
        VALUES (
            #{objectName},
            #{belongType},
            #{iconUrl},
            string_to_array(#{mapIds}, ',')::integer[],
            ST_GeomFromText(#{areaContent}, 0),
            NOW(),
            NOW()
        )
    </insert>

    <!-- 查询区域列表 -->
    <select id="list" resultType="com.ifengniao.server.xiyoucloud.entity.ProductAreaEntity">
        SELECT
            pa.area_id AS areaId,
            pa.object_name AS objectName,
            pa.belong_type AS belongType,
            pa.icon_url AS iconUrl,

            -- ★ 把 {1,2} → "1,2"
            trim(both '{}' from pa.map_ids::text) AS mapIds,

            ST_AsText(pa.area_content) AS areaContent,
            pa.create_time AS createTime,
            pa.update_time AS updateTime,

            -- ★ 查询地图名称
            (
                SELECT string_agg(m.map_cpa_name, ',')
                FROM xy_map m
                WHERE m.map_id = ANY(pa.map_ids)
            ) AS mapNames

        FROM xy_product_area pa
        ORDER BY pa.area_id DESC
    </select>

    <!-- ✅【新增】根据 areaId 查询区域详情（H5 使用） -->
    <select id="getById" parameterType="int"
            resultType="com.ifengniao.server.xiyoucloud.entity.ProductAreaEntity">
        SELECT
            pa.area_id AS areaId,
            pa.object_name AS objectName,
            pa.belong_type AS belongType,
            pa.icon_url AS iconUrl,

            -- map_ids 转成 "1,2"
            trim(both '{}' from pa.map_ids::text) AS mapIds,

            -- ★ 核心：返回 POLYGON((...))
            ST_AsText(pa.area_content) AS areaContent,

            pa.create_time AS createTime,
            pa.update_time AS updateTime
        FROM xy_product_area pa
        WHERE pa.area_id = #{areaId}
        LIMIT 1
    </select>

    <!-- 修改区域 -->
    <update id="update" parameterType="com.ifengniao.server.xiyoucloud.entity.ProductAreaEntity">
        UPDATE xy_product_area
        SET
            object_name = #{objectName},
            belong_type = #{belongType},
            icon_url = #{iconUrl},
            map_ids = string_to_array(#{mapIds}, ',')::integer[],
            area_content = ST_GeomFromText(#{areaContent}, 0),
            update_time = NOW()
        WHERE area_id = #{areaId}
    </update>

    <!-- 删除区域 -->
    <delete id="delete" parameterType="java.lang.Integer">
        DELETE FROM xy_product_area WHERE area_id = #{areaId}
    </delete>

    <!-- 根据 map_ids 查询 map 名称 -->
    <select id="getMapNamesByIds" parameterType="list" resultType="string">
        SELECT map_cpa_name
        FROM xy_map
        WHERE map_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

</mapper>
